pool:
  vmImage: 'windows-latest'

pr:
  branches:
    include:
    - master

stages:
- stage: Test
  displayName: Test and Analyze
  jobs:
  - template: JobTemplates\PesterTests.yml
    parameters:
      TestsPath: 'Tests'
      ResultsPath: 'Publish'
      TestResultsFile: 'Q-Test-Pester.xml'
      Tag: 'Quality'
      Verbosity: 'Detailed'
      JobName: 'QualityTests'
      JobDisplayName: 'Pester Code Quality Test'
  - template: JobTemplates\PesterTests.yml
    parameters:
      TestsPath: 'Tests'
      ResultsPath: 'Publish'
      TestResultsFile: 'U-Test-Pester.xml'
      Tag: 'Unit'  
      Verbosity: 'Detailed'
      JobName: 'UnitTests'
      JobDisplayName: 'Pester Unit Test'
  - template: JobTemplates\PesterTests.yml
    parameters:
      TestsPath: 'Tests'
      ResultsPath: 'Publish'
      TestResultsFile: 'A-Test-Pester.xml'
      Tag: 'Acceptance'
      Verbosity: 'Detailed'
      JobName: 'AccptanceTests'
      JobDisplayName: 'Pester Acceptance Test'
  - job: Publish
    displayName: Publish
    - task: CopyFiles@2
      displayName: 'Copy PSScripts Files to: $(Build.ArtifactStagingDirectory)'
      inputs:
        Contents: 'Resources/PowerShellScripts/**/*.ps1'
        TargetFolder: '$(Build.ArtifactStagingDirectory)/Resources/PSScripts'
        flattenFolders: true
    - task: PublishPipelineArtifact@0
      displayName: Publish PSScripts Pipeline Artifact
      inputs:
        targetPath: $(Build.ArtifactStagingDirectory)/Resources/PSScripts
        artifactName: PowerShellScripts